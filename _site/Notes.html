<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Notes – Heat and Occupation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="assets_css/styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Heat and Occupation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./heat_and_occupation.html"> 
<span class="menu-text">Heat and Occupation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./methods.html"> 
<span class="menu-text">Methods</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Notes</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div>
<p>Bootswatch project themes: journal, lux, sandstone, slate, solar</p>
</div>
<hr>
<section id="data-sources" class="level1">
<h1><strong>Data Sources</strong></h1>
<section id="data-general-cont." class="level3">
<h3 class="anchored" data-anchor-id="data-general-cont."><strong>Data general (cont.)</strong></h3>
<ul>
<li><p>Emergency department encounters: various available but Pivot profiles includes all ED data files and inpatient discharge data file (for admissions originating in the emergency department) aggregated at the hospital level. number of visits, expected payer, discharge disposition, age groups, sex, preferred language spoken, race groups, principal diagnosis groups, and principal external cause of injury/morbidity groups. – find source link</p></li>
<li><p>CDC heat and Health Index (<a href="https://ephtracking.cdc.gov/Applications/heatTracker/">HHI</a>) this can be joined with labor occupation data from BLS or ACS to find the percentage of warehouse/ logistics workers and other industries that may be disproportionately impacted by indoor heat&nbsp;</p>
<ul>
<li>“(HHI) incorporates historical temperature, heat-related illness, and community characteristics data at the ZIP code level” – need to add occupation to this data</li>
</ul></li>
<li><p><a href="https://ephtracking.cdc.gov/Applications/heatTracker/">CDC Heat/ health tracke</a>r: daily heat related illness: daily ED visits due to heat related illness per 100k – further disaggregated by sex and age– <strong>we have the opportunity to disaggregate by occupation and race</strong></p>
<ul>
<li>Source: National Syndromic Surveillance Program (<a href="https://www.cdc.gov/nssp/index.html">NSSP</a>)</li>
</ul></li>
<li><p><a href="https://www.epa.gov/climate-indicators/closer-look-heat-related-workplace-deaths#ref5">US EPA Heat related workplace deaths</a>: 2 categories construction and all other sectors&nbsp;</p>
<ul>
<li><p>construction occupation comprised a large share of deaths relative to all other sectors&nbsp;</p></li>
<li><p>1992 -2022, “334 construction workers lost their lives to heat exposure on the job—meaning that the construction sector accounted for about 34 percent of all occupational heat-related deaths (see Figure 1).”</p></li>
</ul></li>
<li><p><a href="https://data.web.health.state.mn.us/heat_ed">Minnesota dept. Public health</a>: straight forward heat related emergency department (ED) visits&nbsp;</p>
<ul>
<li>Typical example of the limits of analyzing heat: only go as far to dissagregate by sex and age</li>
</ul></li>
</ul>
<section id="data-source-iv-webscraping-osha-establishment-searches" class="level4">
<h4 class="anchored" data-anchor-id="data-source-iv-webscraping-osha-establishment-searches">Data Source IV: webscraping OSHA establishment searches</h4>
<pre><code></code></pre>
<p><strong>Methods Q:</strong> webscrape search by industry, or do a broad establishment search? I think broad establishment search of all of So Cal or all of california? then subset by all these zip codes? Or start by zip code (one by one) that ultimately encompasses area of interest.</p>
<ul>
<li>by region: Region 3 – Santa Ana Regional Office, Region 4 – Monrovia Regional Office</li>
</ul>
<ol type="1">
<li><p>Industry specific search: search by naics, all else is relatively the same</p></li>
<li><p>The Establishments Search results page- will do establishment search</p>
<p>Searching/ identifying material on any of these bases/ extractable things</p></li>
</ol>
<ul>
<li><p>Activity - Provides a unique identifier for the inspection. By clicking this link, specific information for this inspection will be displayed.</p></li>
<li><p>Opened - the date the inspection was started.</p></li>
<li><p>RID - Identifies the OSHA office or organizational unit responsible for the inspection.</p></li>
<li><p>St - Indicates the state postal abbreviation of the inspection site.</p></li>
<li><p>Type - Indicates the impetus for actually performing the inspection; e.g., may be part of a planned schedule, accident, complaint, etc.</p></li>
<li><p>Sc - Indicates whether a complete, partial or records only inspection was performed; may also indicate no inspection if for some reason the inspection could not take place.</p></li>
<li><p>SIC - Indicates the 4-digit Standard Industrial Classification Code from the 1987 version SIC manual which most closely applies. By clicking on this link, the SIC description is displayed.</p></li>
<li><p>Vio - Indicates the number of OSHA standards which were cited.</p></li>
<li><p>Establishment Name - Identifies the establishment that was inspected.</p></li>
</ul>
<p>Searches may be sorted by Date, Name, Office, or State. Searches are sorted by date in descending order by default. Clicking on Date will sort on the date in ascending order. Clicking the check box next to the search result and clicking the Get Detail button will display the inspection details for each inspection. If more than 20 results are returned, click on the arrow next to the Result Page text to navigate to the other search results. To return to the search page to perform another search, click on the Return to Search link.</p>
</section>
<section id="data-fact-source-5" class="level4">
<h4 class="anchored" data-anchor-id="data-fact-source-5"><strong>Data/ fact source 5:</strong></h4>
<p>out there: <a href="https://www.osha.gov/injuryreporting">injury tracking application.</a>: look for heat related injuries</p>
</section>
<section id="data-source-i-cont-quarterly-census-of-employment-and-wages-qcew" class="level4">
<h4 class="anchored" data-anchor-id="data-source-i-cont-quarterly-census-of-employment-and-wages-qcew"><strong>Data Source I (cont): Quarterly Census of Employment and Wages QCEW</strong></h4>
<ul>
<li><p>Purpose: quarterly count of employment and wages by county, MSA, state, etc, by AREA and <strong>NAICS (industry)</strong>.&nbsp;</p></li>
<li><p><strong>CALCULATIONS:</strong></p>
<ul>
<li><p>% change in employment: (Growth) (warehouse/ logistics, carwash, fast food/ service)</p></li>
<li><p>Warehouse: all other sectors ratio&nbsp;</p></li>
<li><p>&nbsp;county level, zoom into city level e.g.: SB county, San bernardino city, Vernon, Commerce…&nbsp;</p></li>
</ul></li>
<li><p>Annual vs quarterly? Whats the difference? Not sure&nbsp;</p></li>
</ul>
<p><strong>EPA</strong>: Regarding <a href="https://www.epa.gov/climate-indicators/closer-look-heat-related-workplace-deaths#ref7">A Closer Look: Heat-Related Workplace Deaths</a></p>
<ul>
<li>&nbsp;“Data for this feature were provided by BLS. The data in Figure 1 are publicly available on the BLS Injuries, Illnesses, and Fatalities website at: <a href="http://www.bls.gov/iif/home.htm">www.bls.gov/iif/home.htm</a>. Data for the outdoor workers map figure came from BLS’s Quarterly Census of Employment and Wages: <a href="http://www.bls.gov/cew/downloadable-data-files.htm">www.bls.gov/cew/downloadable-data-files.htm</a>.”</li>
</ul>
<p><strong>QCEW data structure(cont.)</strong></p>
<ul>
<li><p>QCEW CSV files sliced by industry, area, and establishment size-class.&nbsp;</p>
<ul>
<li><p>industry slice: all&nbsp; records associated w/ the industry for a single time period.&nbsp;</p></li>
<li><p>area slice: all the records associated w/ the area for a single time period.&nbsp;</p></li>
<li><p>size slice: all records published w/ in a specific size class for the 1st Q of specified year.</p></li>
</ul></li>
<li><p>QCEW: can I find NAICS carwash/ warehouses – probably available, the feature from the <a href="https://www.epa.gov/climate-indicators/closer-look-heat-related-workplace-deaths#ref5">EPA</a> uses data from here to map the density of outdoor workers by county</p></li>
</ul>
<p><strong>Concretizing / Data Viz ideas</strong></p>
<ul>
<li><p>Mapping heat/ temperatures and carwash/ warehouse density in a given zipcode, merge CDC heat and health index (see above). maybe just need average temperatures instead of an heat and health index</p></li>
<li><p>Common identifier: zipcode, NAICS, geospaital point? Coordinate?&nbsp;</p></li>
</ul>
</section>
<section id="data-source-ii-injuries-illnesses-and-fatalities-database" class="level4">
<h4 class="anchored" data-anchor-id="data-source-ii-injuries-illnesses-and-fatalities-database"><strong>Data source II: Injuries, Illnesses, and Fatalities <a href="https://www.bls.gov/iif/data.htm">database</a></strong></h4>
<ul>
<li><p>Source: Census of Fatal Occupational Injuries (CFOI) gathered by BLS is available at <a href="https://www.bls.gov/iif/data.htm" class="uri">https://www.bls.gov/iif/data.htm</a>&nbsp;</p>
<ul>
<li>Article Source: Acloser look– <a href="https://www.epa.gov/climate-indicators/closer-look-heat-related-workplace-deaths#ref7">EPA Heat related workplace deaths&nbsp;</a></li>
</ul></li>
<li><p>Source: <strong>Occupational Injuries and Illnesses by industry data available there^</strong></p></li>
</ul>
</section>
<section id="data-source-iii" class="level4">
<h4 class="anchored" data-anchor-id="data-source-iii"><strong>Data Source III</strong></h4>
<ul>
<li>Possible source for location of warehouses see bookmarks bar, rocket mortgage</li>
</ul>
<p><a href="https://www.productive-r-workflow.com/quarto-tricks#toc">quarto tips and tricks</a> - has a ton of good tips, footnotes, iframe, tabs, etc</p>
<p><a href="https://quarto.org/docs/authoring/figures.html">quarto bookdown</a> - quarto documentation</p>
<ul>
<li>under HTML theming: once theme is chosen, can customize the theme presets such as font family (serif, georgia etc), base font size, background color, linestretch (distance between lines of text, defaults to 1.5)</li>
</ul>
<p><a href="https://bookdown.org/yihui/rmarkdown/html-document.html">rmd bookdown</a></p>
<p>{r, echo = FALSE, out.width = “45”} knitr::include_graphics(c(“images/socalcoshlogo.jpg”, “images/uclalosh.png”)) #<img src="images/socalcoshlogo.jpg" class="img-fluid quarto-figure quarto-figure-left" width="233"></p>
<p><strong>Figure Divs</strong></p>
<p>You can treat any markdown content you want as a figure by enclosing it in Pandoc div block with an identifier prefaced with #fig-. For example, here we create a figure that includes an embedded iframe:</p>
<div id="fig-elephant" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-elephant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<iframe width="560" height="315" src="https://www.youtube.com/embed/SNggmeilXDQ">
</iframe>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elephant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Elephant
</figcaption>
</figure>
</div>
<p>Note that the last paragraph in the div block is used as the figure caption.</p>
<p>Note on Images:</p>
<p>well the only way I was able to get the images side by side was by the current</p>
<p><a href="https://rstudio4edu.github.io/rstudio4edu-book/rmd-fancy.html">Making your Rmd fancy:</a> Adding a big image to the front of the page with the title also present is called a hero image</p>
<p><strong>Bookdown books</strong></p>
<p><a href="https://handsondataviz.org/organization.html">hands on data visualization</a> - Jack dougherty - <strong>not an R book</strong></p>
<ul>
<li><p>all about data viz and commmunicating social sci data effectively</p></li>
<li><p>geospatial data</p></li>
<li><p>chart.js/ highchart good templates</p></li>
<li><p>also geospatial is his book <a href="https://ontheline.trincoll.edu">On The Line</a></p></li>
</ul>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>