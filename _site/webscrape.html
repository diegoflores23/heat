<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CALOSHA establishment search web scrape – Heat and Occupation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="assets_css/styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Heat and Occupation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./heat_and_occupation.html"> 
<span class="menu-text">Heat and Occupation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./methods.html"> 
<span class="menu-text">Methods</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CALOSHA establishment search web scrape</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="notes-for-webscraping" class="level2">
<h2 class="anchored" data-anchor-id="notes-for-webscraping">Notes for webscraping</h2>
<p><strong>for webscraping:</strong></p>
<p><strong><em>rvest</em></strong> if it works well for static site scrapping and also web browser control (with&nbsp;<code>read_html_live()</code>):&nbsp;<a href="https://rvest.tidyverse.org/" class="uri">https://rvest.tidyverse.org/</a> dev. by wickham</p>
<ul>
<li><strong>Pagination</strong>: See his github rvest <a href="https://github.com/hadley/web-scraping/blob/main/pagination.R">here</a>, uses httr to scrape multiple pages</li>
</ul>
<p>Hayalbaz if you need more interaction :&nbsp;<a href="https://github.com/rundel/hayalbaz" class="uri">https://github.com/rundel/hayalbaz</a></p>
<p>A nice playlist on how to use rvest by data slice:&nbsp;<a href="https://youtube.com/playlist?list=PLr5uaPu5L7xLEclrT0-2TWAz5FTkfdUiW&amp;si=FWa02M1Qq7uLBMDB" class="uri">https://youtube.com/playlist?list=PLr5uaPu5L7xLEclrT0-2TWAz5FTkfdUiW&amp;si=FWa02M1Qq7uLBMDB</a></p>
<p><strong>to read pdf content:</strong></p>
<p>readtext (wrap pdftools and more):&nbsp;<a href="https://github.com/quanteda/readtext" class="uri">https://github.com/quanteda/readtext</a></p>
<p>pdftools:&nbsp;<a href="https://cran.r-project.org/web/packages/pdftools/index.html" class="uri">https://cran.r-project.org/web/packages/pdftools/index.html</a></p>
<p>Criminologist jail/ prison extraction data using pdftools package:</p>
<p>Since other packages to extract tables from pdf have maintenance or dependency issues (with java) here is a tutorial using pdftools (a bit long):&nbsp;<a href="https://crimebythenumbers.com/scrape-table.html" class="uri">https://crimebythenumbers.com/scrape-table.html</a></p>
<p>For more complex sites, you might need to deal with JavaScript-rendered content. In such cases,&nbsp;<code>RSelenium</code>&nbsp;is a great tool. It allows you to automate a web browser, interact with dynamic content, and scrape data that isn’t readily available in the static HTML.</p>
<p><strong>To scrape:</strong></p>
<ul>
<li>webscrape CALOSHA website (not really up to date) on <a href="https://www.dir.ca.gov/dosh/statistics/Complaints-and-citations.html">complaints received and citations issued</a></li>
</ul>
<section id="calosha-inspection-details-notes" class="level4">
<h4 class="anchored" data-anchor-id="calosha-inspection-details-notes"><strong>Calosha inspection details notes</strong></h4>
<ol type="1">
<li>order: close pop up (if needed)&gt; establishment search (California, monrovia office, case status: all, violation status: With Violations), date, press search &gt; Click <strong>Activity</strong> &gt;<strong>Inspection Nr</strong>: 1760736.015, <strong>Report ID:</strong> 0950644, <strong>Date Opened:</strong> 06/13/2024, <strong>Site Address, Union Status, NAICS, Mailing Address,</strong> <strong>Inspection Type, Scope, Advanced Notice, Ownership, Safety/Health, Close</strong> <strong>Conference</strong>, <strong>Emphasis</strong>, <strong>Case</strong> <strong>Closed</strong>,</li>
<li>Locate <strong>violation</strong> <strong>summary</strong>: Current Violations - Total, Current Penalty - Total</li>
<li>Locate <strong>Violation</strong> <strong>Items</strong>: Get <strong>Standard</strong> <strong>Cited</strong> only if it is 3395? or get all standards cited, regardless retrieve <strong>Standard</strong> <strong>cited</strong>, <strong>Issuance</strong> <strong>Date</strong>, <strong>Abatement</strong> <strong>Due</strong> <strong>Date</strong>, <strong>current</strong> <strong>penalty</strong></li>
</ol>
<ul>
<li><p><strong>Inspection type:</strong> there are two types– programmed and unprogrammed,</p>
<ul>
<li><p>A Fatality/Catastrophe Report (FAT/CAT),</p></li>
<li><p>Complaint</p></li>
<li><p>Accident</p></li>
</ul></li>
</ul>
<p><strong>notes from lex (osha rep):</strong></p>
<p>In the case you referenced below, there are indicators of what type of inspection: Accident and Complaint Inspections are” Unprogrammed Inspections:” and in most cases are also “Partial” Inspections (focused on the specific accident or the complaint item, although some complaints could be “Comprehensive”).</p>
<p>Inspection Type: Complaint</p>
<p>Scope: Partial</p>
<p>Advanced Notice: N</p>
<p>Ownership: Private</p>
<p>Safety/Health: Health</p>
<p>Close Conference: 12/15/2023</p>
<p>Emphasis:</p>
<p>Case Closed: 01/30/2024</p>
<p>Programmed inspections, like those conducted by my office will always be “Comprehensive”. IN all cases, there is never an announcement of a pending inspection. Notice is never given to any employer, by law in Cal OSHA</p>
<p>Data analysis:</p>
<ul>
<li><p>see which industries are most cited</p></li>
<li><p>What percent of complaints actually result in violations? This is 5 year range 1059/ 1706 – 62%</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("rvest")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("pdftools")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("xml2")</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("RSelenium")</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("binman")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdftools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using poppler version 23.04.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wdman)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(binman)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#FAILED - server request 403 </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#url &lt;- "https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=all&amp;startmonth=09&amp;startday=30&amp;startyear=2019&amp;endmonth=09&amp;endday=30&amp;endyear=2024"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set user agent </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#response &lt;- GET(url, </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">user_agent</span>(<span class="st">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span>)<span class="er">)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#if (status_code(response) == 200) {</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the content of the webpage</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#webpage &lt;- read_html(content(response, "text"))</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the first table from the page</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a> <span class="co"># table &lt;- webpage %&gt;% </span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>   <span class="co"># html_nodes("table") %&gt;%     # Find all tables on the page</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  .[[1]] %&gt;%                  # Select the first table (adjust index if needed)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>   <span class="co"># html_table(fill = TRUE)      # Convert HTML table to data frame</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the table</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(table)</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">#} else {</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Failed to retrieve the webpage. Status code: "</span>, <span class="fu">status_code</span>(response))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">#}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#FAILED - not recgonzing referer, user agent issues </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=all&amp;startmonth=09&amp;startday=30&amp;startyear=2019&amp;endmonth=09&amp;endday=30&amp;endyear=2024"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set HTTP headers to mimic a real browser</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># adding more user agent headers, simulate real users </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url, </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">user_agent</span>(<span class="st">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">add_headers</span>(.  </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Referer</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"https://www.google.com"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Accept-Language</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"en-US,en;q=0.9"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Cache-Control</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"max-age=0"</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the request was successful</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse the content of the webpage</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  webpage <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the first table from the page</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  table <span class="ot">&lt;-</span> webpage <span class="sc">%&gt;%</span> </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_nodes</span>(<span class="st">"table"</span>) <span class="sc">%&gt;%</span>     <span class="co"># Find all tables on the page</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    .[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span>                  <span class="co"># Select the first table (adjust index if needed)</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_table</span>(<span class="at">fill =</span> <span class="cn">TRUE</span>)      <span class="co"># Convert HTML table to data frame</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the table</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(table)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Failed to retrieve the webpage. Status code: "</span>, <span class="fu">status_code</span>(response))</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Attempt II. rvest xml2 and tibbles</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#store url </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>url2 <span class="ot">&lt;-</span> <span class="st">"https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=all&amp;startmonth=09&amp;startday=30&amp;startyear=2019&amp;endmonth=09&amp;endday=30&amp;endyear=2024"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#scrape htmlinfo from stored url </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>base_webpage <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url2)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#loop </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>new_url2 <span class="ot">&lt;-</span> <span class="st">"https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=all&amp;startmonth=09&amp;startday=30&amp;startyear=2019&amp;endmonth=09&amp;endday=30&amp;endyear=2024/%s"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating dataframe of the first 100 movies:</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># html_table() converts html tables into dataframes.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>table_base <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_table</span>(base_webpage) [[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>(<span class="at">.name_repair =</span> <span class="st">"unique"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>table_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">101</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Creating data out of the next set of tables </span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (i<span class="sc">&lt;</span><span class="dv">5502</span>) {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  new_webpage<span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">sprintf</span>(new_url2,i))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  table_new <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_table</span>(new_webpage)[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>(<span class="at">.name_repair =</span> <span class="st">"unique"</span>) <span class="co"># repair the repeated columns</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  df<span class="ot">&lt;-</span> <span class="fu">rbind</span>(df,table_new)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  i<span class="ot">=</span>i<span class="sc">+</span><span class="dv">100</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Merge table_base and df </span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>citations <span class="ot">&lt;-</span> <span class="fu">merge</span>(table_base, df, <span class="at">all =</span> T)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(citations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="attempt-iii.-rselenium" class="level4">
<h4 class="anchored" data-anchor-id="attempt-iii.-rselenium">Attempt III. Rselenium</h4>
<p>sites generate dynamic content w/ JavaScript so the raw html of site doesnt help much. <a href="https://www.r-bloggers.com/2014/12/scraping-with-selenium/#google_vignette">Rblogger</a> tutorial (2014) outdated, using appsilon tutorial</p>
<ul>
<li><p>latest chromedriver version installed: 129.0.6668.89, somehow my R cannot access it it conitnues to access an older version of it 106. tried everything, I manually installed driver 129 for browser and driver compatibility.</p></li>
<li><p>I dwonloaded driver 129 <a href="https://googlechromelabs.github.io/chrome-for-testing/">here</a></p></li>
</ul>
<p>Chrome attempt didnt work. chrome driver incompatibility, saved by firefox</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#NOT WORKING</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#rD &lt;- RSelenium::rsDriver() #only supports v.106, have v.129</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check supported chrome versions. </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>binman<span class="sc">::</span><span class="fu">list_versions</span>(<span class="at">appname =</span> <span class="st">"chromedriver"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>rD <span class="ot">&lt;-</span> RSelenium<span class="sc">::</span><span class="fu">rsDriver</span>(<span class="at">browser =</span> <span class="st">"chrome"</span>, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">port =</span> <span class="dv">53924</span>L, <span class="at">chromever =</span> <span class="st">"129.0.6668.89"</span>) </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#troubleshooting below </span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the path to your ChromeDriver</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>chrome_driver_path <span class="ot">&lt;-</span> <span class="st">"/Users/diegoflores/Downloads/chromedriver-mac-arm64-2/chromedriver"</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Start RSelenium with the path to the driver</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>rD <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(<span class="at">browser =</span> <span class="st">"chrome"</span>, <span class="at">chromever =</span> <span class="st">"129.0.6668.89"</span>, <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">chromeOptions =</span> <span class="fu">list</span>(<span class="at">binary =</span> chrome_driver_path)))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>binman<span class="sc">::</span><span class="fu">list_versions</span>(<span class="at">appname =</span> <span class="st">"chromedriver"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>rD <span class="ot">&lt;-</span> RSelenium<span class="sc">::</span><span class="fu">rsDriver</span>(<span class="at">browser =</span> <span class="st">"chrome"</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">chromever =</span> <span class="st">"106.0.5249.21"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Working with elements</strong></p>
<ul>
<li><p><code>findElement(using, value)</code>: Search for an element on the page, starting from the document root. The located element will be returned as an object of webElement class. To use this need some basic knowledge of HTML/ CSS (or xpath, etc). Chrome extension, called <a href="https://chrome.google.com/webstore/detail/selectorgadget/mhjhnkcfbdhnjickkkdbjoemdmbfginb?hl=es"><strong>SelectorGadget</strong></a>, might help.</p></li>
<li><p><code>highlightElement()</code>: Utility function to highlight current Element. This helps to check that you selected the wanted element.</p></li>
<li><p><code>sendKeysToElement()</code>: Send a sequence of keystrokes to an element. The keystrokes are sent as a list. Plain text is entered as an unnamed element of the list. Keyboard entries are defined in ’selKeys‘ and should be listed with the name ’key‘.</p></li>
<li><p><code>clearElement()</code>: Clear a TEXTAREA or text INPUT element’s value.</p></li>
<li><p><code>clickElement()</code>: Click the element. You can click links, check boxes, dropdown lists, etc.</p></li>
<li><p>LATEST UPDATE:</p>
<ul>
<li><p>succesful but the table output isnt that nice I need to first get the top header (whihc has the variables names) am I analyzing by column or row or both, or how do I think about the scrape?</p></li>
<li><p>I think I successfully extracted all of the first table? now I need to loop it!! figure out pagination</p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rD <span class="ot">&lt;-</span> RSelenium<span class="sc">::</span><span class="fu">rsDriver</span>(<span class="at">browser =</span> <span class="st">"firefox"</span>, <span class="at">port =</span> <span class="dv">4569</span>L) <span class="co"># start session</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>checking Selenium Server versions:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: PREDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: DOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: POSTDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>checking chromedriver versions:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: PREDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: DOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: POSTDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>checking geckodriver versions:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: PREDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: DOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: POSTDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>checking phantomjs versions:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: PREDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: DOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>BEGIN: POSTDOWNLOAD</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Connecting to remote server"
$acceptInsecureCerts
[1] FALSE

$browserName
[1] "firefox"

$browserVersion
[1] "131.0"

$`moz:accessibilityChecks`
[1] FALSE

$`moz:buildID`
[1] "20240923135042"

$`moz:geckodriverVersion`
[1] "0.35.0"

$`moz:headless`
[1] FALSE

$`moz:platformVersion`
[1] "23.6.0"

$`moz:processID`
[1] 48784

$`moz:profile`
[1] "/var/folders/dc/92b4rct96931sct_xtgblqv00000gn/T/rust_mozprofileWglYQs"

$`moz:shutdownTimeout`
[1] 60000

$`moz:webdriverClick`
[1] TRUE

$`moz:windowless`
[1] FALSE

$pageLoadStrategy
[1] "normal"

$platformName
[1] "mac"

$proxy
named list()

$setWindowRect
[1] TRUE

$strictFileInteractability
[1] FALSE

$timeouts
$timeouts$implicit
[1] 0

$timeouts$pageLoad
[1] 300000

$timeouts$script
[1] 30000


$unhandledPromptBehavior
[1] "dismiss and notify"

$userAgent
[1] "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:131.0) Gecko/20100101 Firefox/131.0"

$webdriver.remote.sessionid
[1] "8d2e7a4b-8c8e-478c-923a-208100b7cbec"

$id
[1] "8d2e7a4b-8c8e-478c-923a-208100b7cbec"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>remDr <span class="ot">&lt;-</span> rD[[<span class="st">"client"</span>]] <span class="co"># Assign the client to an object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>remDr<span class="sc">$</span><span class="fu">open</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Connecting to remote server"
$acceptInsecureCerts
[1] FALSE

$browserName
[1] "firefox"

$browserVersion
[1] "131.0"

$`moz:accessibilityChecks`
[1] FALSE

$`moz:buildID`
[1] "20240923135042"

$`moz:geckodriverVersion`
[1] "0.35.0"

$`moz:headless`
[1] FALSE

$`moz:platformVersion`
[1] "23.6.0"

$`moz:processID`
[1] 48791

$`moz:profile`
[1] "/var/folders/dc/92b4rct96931sct_xtgblqv00000gn/T/rust_mozprofileg2VPEL"

$`moz:shutdownTimeout`
[1] 60000

$`moz:webdriverClick`
[1] TRUE

$`moz:windowless`
[1] FALSE

$pageLoadStrategy
[1] "normal"

$platformName
[1] "mac"

$proxy
named list()

$setWindowRect
[1] TRUE

$strictFileInteractability
[1] FALSE

$timeouts
$timeouts$implicit
[1] 0

$timeouts$pageLoad
[1] 300000

$timeouts$script
[1] 30000


$unhandledPromptBehavior
[1] "dismiss and notify"

$userAgent
[1] "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:131.0) Gecko/20100101 Firefox/131.0"

$webdriver.remote.sessionid
[1] "6d65c50b-10d7-4fe2-8574-23808cbbfea1"

$id
[1] "6d65c50b-10d7-4fe2-8574-23808cbbfea1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#web scrape </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=yes&amp;startmonth=10&amp;startday=03&amp;startyear=2019&amp;endmonth=10&amp;endday=03&amp;endyear=2024"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>remDr<span class="sc">$</span><span class="fu">navigate</span>(base_url)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys.sleep(4) # seconds</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">#webElem &lt;- remDr$findElement(using = "css selector", value = "div.table-responsive:nth-child(8) &gt; table:nth-child(1)") </span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># webElem$highlightElement()</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>remDr<span class="sc">$</span><span class="fu">maxWindowSize</span>()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">#keep the browser active, open(silent = FALSE)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">#remDr$open() #use this if server is already active</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">#remDr$close() #close current session </span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>source <span class="ot">&lt;-</span> remDr<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]<span class="co"># read page source from where you navigated </span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># get all rows of table in an xml list </span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>table_body  <span class="ot">&lt;-</span> <span class="fu">read_html</span>(source) <span class="sc">%&gt;%</span> <span class="co">#table_body is xml list </span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"div.table-responsive:nth-child(8) &gt; table:nth-child(1) &gt; tbody:nth-child(2)"</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1: div.table-responsive:nth-child(8) &gt; table:nth-child(1) - same result as </span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2: div.table-responsive:nth-child(8) </span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3: iv.table-responsive:nth-child(8) &gt; table:nth-child(1) &gt; tbody:nth-child(2) </span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a> <span class="co">#Extract all data from table rows</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>table_data <span class="ot">&lt;-</span> table_body <span class="sc">%&gt;%</span> <span class="co"># then table body is passed to html_nodes to extract </span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"tr"</span>) <span class="sc">%&gt;%</span> <span class="co"># first get all rows (tr) separately </span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"td"</span>) <span class="sc">%&gt;%</span> <span class="co"># then get all cells (td)</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text2</span>()         <span class="co"># html_text() retrives text from html element</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(table_data)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(table_data) <span class="co">#length = 240, / by 12 = 20 </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 240</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get column names, turn into list, when transforming into df, the ncol = the list column_length</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>column_names <span class="ot">&lt;-</span> <span class="fu">read_html</span>(source) <span class="sc">%&gt;%</span>  <span class="co"># extract list of column names, convert to text after</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"div.table-responsive:nth-child(8) &gt; table:nth-child(1) &gt; thead:nth-child(1)"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"th"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text2</span>()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(column_names) <span class="co"># vector of 12 names, just a check</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] " "                  "#"                  "Activity"          
 [4] "Date Opened"        "RID"                "ST"                
 [7] "Type"               "Scope"              "SIC"               
[10] "NAICS"              "Violations"         "Establishment Name"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>column_length <span class="ot">&lt;-</span> <span class="fu">length</span>(column_names) <span class="co"># length gets/sets the length of a vector(lists)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(column_length) <span class="co"># 12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First turn lists into matrix w correct # of cols then make a tibble </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">matrix</span>(table_data, <span class="at">ncol =</span> column_length, <span class="at">byrow =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if
`.name_repair` is omitted as of tibble 2.0.0.
ℹ Using compatibility `.name_repair`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> column_names <span class="co"># ADD PIPE TO DROP ROWS 1:2 </span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#str(df) # all chrs, row 1:2 need to drop</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NOT WORKING RN </span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigating to sub pages on the Activtiy # the a elements </span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>a_elements <span class="ot">&lt;-</span> <span class="fu">read_html</span>(remDr<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"tr"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"td"</span>) <span class="sc">%&gt;%</span> <span class="co">#get a elemtns from the source (html) of the base_url</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="at">css =</span> <span class="st">"div.package &gt; a"</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>a_elements</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>website_html <span class="ot">&lt;-</span> <span class="st">"https://www.osha.gov/ords/imis/establishment.search?p_logger=1&amp;establishment=&amp;State=CA&amp;officetype=all&amp;Office=950644&amp;sitezip=&amp;p_case=all&amp;p_violations_exist=yes&amp;startmonth=10&amp;startday=03&amp;startyear=2019&amp;endmonth=10&amp;endday=03&amp;endyear=2024"</span> <span class="sc">%&gt;%</span> </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_html</span>()</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>td_cell_elements <span class="ot">&lt;-</span> source <span class="sc">%&gt;%</span> </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"tr"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"td"</span>) </span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#bcus a elements (links) are inside the td (cells) i must extract all a tags w/ in the td cells </span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>a_elements <span class="ot">&lt;-</span> td_cell_elements <span class="sc">%&gt;%</span>  </span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="st">"a"</span>) <span class="co"># selecting the a elements from the html source - here its from the td_cel_elements html source</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>a_elements_links <span class="ot">&lt;-</span> a_elements <span class="sc">%&gt;%</span> </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_attr</span>(<span class="st">"href"</span>) <span class="co">#gets attribute from html source code </span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>a_element_links</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#working </span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>webElem <span class="ot">&lt;-</span> remDr<span class="sc">$</span><span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"css selector"</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">value =</span><span class="st">"tbody tr:nth-child(1) td:nth-child(3)"</span>) <span class="co">#relative css selector </span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>webElem<span class="sc">$</span><span class="fu">clickElement</span>() </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># works with relative css selector and absolute css and absolute xpath </span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>source <span class="ot">&lt;-</span> remDr<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]] <span class="co"># source() retrieves current HTML of webpage as a list, and [[1]] extracts the first </span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="co"># (and only) item in that list, which is full HTML code as a string</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>table_body2 <span class="ot">&lt;-</span> <span class="fu">read_html</span>(source) <span class="sc">%&gt;%</span> </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"div.row-fluid:nth-child(9)"</span>) <span class="sc">%&gt;%</span>  <span class="co"># using html nodes to select elements based on their </span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"div.row-fluid:nth-child(11)"</span>) <span class="sc">%&gt;%</span> <span class="co"># html structure/ class attributes, then extracting </span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">".tablei &gt; tbody:nth-child(2) &gt; tr:nth-child(3) &gt; td:nth-child(7)"</span>) <span class="sc">%&gt;%</span> <span class="co"># text or </span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">".tablei &gt; tbody:nth-child(2) &gt; tr:nth-child(5) &gt; td:nth-child(7)"</span>) <span class="sc">%&gt;%</span> <span class="co"># attributes</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text2</span>() </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>table_data2 <span class="ot">&lt;-</span> table_body2 <span class="sc">%&gt;%</span> <span class="co"># then table body is passed to html_nodes to extract </span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"tr"</span>) <span class="sc">%&gt;%</span> <span class="co"># first get all rows (tr) separately </span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"td"</span>) <span class="sc">%&gt;%</span> <span class="co"># then get all cells (td)</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text2</span>()         <span class="co"># html_text() retrives text from html element</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(table_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## DEBUGGING## # alternative approach below, fixed code above was missing html_nodes("th") in order to extract cell</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">##               values of the css selector </span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Up to this point 10/7 the data wasnt scraped properly, it is in a long 1 column dataframe </span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#num_cols &lt;- 12</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#num_rows &lt;- length(table_data)/num_cols</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># matrix_table_data &lt;- matrix(table_data, ncol = num_cols, byrow = TRUE) %&gt;% </span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a> <span class="co"># as_tibble()</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(matrix_table_data) &lt;- column_names</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># there is an issue w the way column names are being extracted, try different css selector, if it fails, try new written</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># vector </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><u>10/10/2000</u></p>
<ul>
<li><p>do we need the script to create a predefined list for the total activity number? yes i believe</p></li>
<li><p><strong>To do: Following along with web scrape premier league</strong></p></li>
</ul>
<ol type="1">
<li>create a list of all activity numbers (href links) from the readable HTML source (its a string from a list)</li>
<li>I.e. <strong>see code chunk.</strong> So i must find all “link” items in the row elements that have attribute href. html_attr then extracts value of the “data-option-name” attribute from the li elements, which are the season names</li>
<li>“As you can see, we have an attribute named ‘data-dropdown-list’ whose value is ‘FOOTBALL_COMPSEASON’ and inside we have ‘li’ tags where the attribute ‘data-option-name’ changes for each season.”</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#FOR EXMAPLE:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>list_seasons <span class="ot">&lt;-</span> <span class="fu">read_html</span>(source) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"ul[data-dropdown-list=         # find all list (li) items in the ul elements that have attribute [data-dropdown-</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="st">             FOOTBALL_COMPSEASON] &gt; li"</span>) <span class="sc">%&gt;%</span> <span class="co"># list=FOOTBALL...] targetting the specific dropdown list for seasons </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_attr</span>(<span class="st">"data-option-name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>10/4/24</p>
<ul>
<li>after I find the correct html elements/ and their css selectors I should replicate the for loop code below to get all html source from all pages, then can parse it out correctly into a dataframe (rvest)</li>
<li>div.table-responsive:nth-child(8) refers to 8th child element div w/ class table responsive</li>
</ul>
<p><strong>10/7/24 - monday</strong></p>
<ul>
<li><p>finally got the base scrape down (df), now I gotta deal with pagination and inspection details</p></li>
<li><p><strong>Pagination</strong>: locate ‘next’ web element to run at the end of the initial scrape, sys.sleep(_), extract only the table body, dont need table headers? See wickham <a href="https://github.com/hadley/web-scraping/blob/main/pagination.R">github</a></p></li>
<li><p><strong>Index pages: Inspection detail:</strong> can navigate and click it, then scrape site address, union status, naics, row fluid class under it, case status, violation summary, and violation items</p>
<ul>
<li><p>the issue here is creating the new variables, will be a new set of 10+ variables – will prolly happen after using same methods</p></li>
<li><p><strong>Violation summary:</strong> only retrieve Current violations/ penalty from the total row</p></li>
<li><p><strong>violation items:</strong> not sure at all how to get standard cited since there is more than 1 unique value there can be x amount of unique standards cited but surely not unlimited, dont need to get all since it is already common knowledge what standards are cited most frequently (provided by OSHA) could probably just check if heat standard is mentioned and if so to make it Y/N</p></li>
</ul></li>
<li><p>wrapper functions:</p></li>
<li><p>ultimate goal:</p></li>
</ul>
<p>&lt;table&gt;&nbsp;</p>
<p>&lt;tr&gt;</p>
<p>&lt;td&gt;Row 1, Cell 1&lt;/td&gt; #td defines a cell in the row</p>
<p>&lt;td&gt;Row 1, Cell 2&lt;/td&gt;</p>
<p>&lt;/tr&gt;&nbsp;</p>
<p>&lt;tr&gt;</p>
<p>&nbsp;&lt;td&gt;Row 2, Cell 1&lt;/td&gt;</p>
<p>&lt;td&gt;Row 2, Cell 2&lt;/td&gt;</p>
<p>&lt;/tr&gt;</p>
<p>&lt;/tr&gt;</p>

<p>&lt;a href=“establishment.inspection detail? id = ####### title =”#######” &gt;</p>
<p><em>1763527.015</em></p>

<p>&nbsp;&lt;/table&gt;</p>
<p><strong>Scraping programmatically from <a href="https://stackoverflow.com/questions/50557299/scrape-a-paginated-table-in-r">stack overflow</a>:</strong> start by writing a function that takes a page number, finds the link for that page, clicks on the link, and returns the HTML source for that page:</p>
<p>useful functions</p>
<ul>
<li><p><code>findElement(using =, value=)</code>: Search for an element on the page, starting from the document root. The located element will be returned as an object of webElement class. To use this function you need some basic knowledge of HTML and CSS (or xpath, etc). Using a Chrome extension, called <a href="https://chrome.google.com/webstore/detail/selectorgadget/mhjhnkcfbdhnjickkkdbjoemdmbfginb?hl=es"><strong>SelectorGadget</strong></a>, might help.</p></li>
<li><p><code>highlightElement()</code>: Utility function to highlight current Element. This helps to check that you selected the wanted element.</p></li>
<li><p><code>sendKeysToElement()</code>: Send a sequence of keystrokes to an element. The keystrokes are sent as a list. Plain text is entered as an unnamed element of the list. Keyboard entries are defined in ’selKeys‘ and should be listed with the name ’key‘.</p></li>
<li><p><strong><code>getPageSource()[[1]]</code>:</strong> <strong>Get the current page source. This method combined with `rvest` is what makes possible to scrape dynamic web pages.</strong> The xml document returned by the method can then be read using <code>rvest::read_html()</code>. This method returns a `list` object, that’s the reason behind <code>[[1]]</code>.</p></li>
</ul>
<pre><code>get_html &lt;- function(i) {
  webElem &lt;- remDr$findElement(using = "link text", as.character(i))
  webElem$clickElement()
  Sys.sleep(s)
  remDr$getPageSource()[[1]]
}</code></pre>
<pre><code>s &lt;- 2 # seconds to wait between each page
total_pages &lt;- 17
html_pages &lt;- vector("list", total_pages)</code></pre>
<p>Start the browser, navigate to page 1, and save the source:</p>
<pre><code>library(RSelenium)
rD &lt;- rsDriver()
remDr &lt;- rD[["client"]]
base_url &lt;- "http://dgsp.cns.gob.mx/Transparencia/wConsultasGeneral.aspx"
remDr$navigate(base_url)
src &lt;- remDr$getPageSource()[[1]]
html_pages[1] &lt;- src</code></pre>
<p>For pages 2 to 17, we use a for-loop and call the function we wrote above, taking care to account specially for page 11:</p>
<pre><code>for (i in 2:total_pages) {
  if (i == 11) {
    webElem &lt;- remDr$findElement(using = "link text", "...")
    webElem$clickElement()
    Sys.sleep(s)
    html_pages[i] &lt;- remDr$getPageSource()[[1]]
  } else {
    html_pages[i] &lt;- get_html(i)  
  }
}
remDr$close()</code></pre>
<p>The result is&nbsp;<code>html_pages</code>, a list of length 17, with each element the HTML source for each page.&nbsp;</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>